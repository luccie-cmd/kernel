mkdir -p bin
mkdir -p bin/kernel
cp ./util/limine.conf bin/limine.conf
cp ./limine/bin/BOOTX64.EFI bin/BOOTX64.EFI
cpp  -Iinclude -Ilibcxx libcxx/stdlib/abort.cc -o ./tmp.txt
cpp  -Iinclude -Ilibcxx libcxx/string/memset.cc -o ./tmp.txt
ar rcs bin/libcxx.a bin/libcxx/stdlib/abort.cc.o bin/libcxx/string/memset.cc.o
ar rcs bin/drivers.a 
cpp  -Iinclude -Ilibcxx -Idrivers -Icommon common/dbg/dbg.cc -o ./tmp.txt
cpp  -Iinclude -Ilibcxx -Idrivers -Icommon common/io/io.cc -o ./tmp.txt
ar rcs bin/common.a bin/common/dbg/dbg.cc.o bin/common/io/io.cc.o
cpp  -Iinclude -Ilibcxx -Idrivers -Icommon -Ikernel -D_GLIBCXX_HOSTED=1 kernel/main.cc -o ./tmp.txt
cpp  -Iinclude -Ilibcxx -Idrivers -Icommon -Ikernel -D_GLIBCXX_HOSTED=1 kernel/driver/driver.cc -o ./tmp.txt
cpp  -Iinclude -Ilibcxx -Idrivers -Icommon -Ikernel -D_GLIBCXX_HOSTED=1 kernel/mmu/pmm/pmm.cc -o ./tmp.txt
cpp  -Iinclude -Ilibcxx -Idrivers -Icommon -Ikernel -D_GLIBCXX_HOSTED=1 kernel/mmu/vmm/vmm.cc -o ./tmp.txt
cpp  -Iinclude -Ilibcxx -Idrivers -Icommon -Ikernel -D_GLIBCXX_HOSTED=1 kernel/mmu/heap/heap.cc -o ./tmp.txt
cpp  -Iinclude -Ilibcxx -Idrivers -Icommon -Ikernel -D_GLIBCXX_HOSTED=1 kernel/mmu/rtl.cc -o ./tmp.txt
cpp  -Iinclude -Ilibcxx -Idrivers -Icommon -Ikernel -D_GLIBCXX_HOSTED=1 kernel/vfs/vfs.cc -o ./tmp.txt
cpp  -Iinclude -Ilibcxx -Idrivers -Icommon -Ikernel -D_GLIBCXX_HOSTED=1 kernel/hal/arch/init.cc -o ./tmp.txt
cpp  -Iinclude -Ilibcxx -Idrivers -Icommon -Ikernel -D_GLIBCXX_HOSTED=1 kernel/hal/arch/x64/gdt/gdt.cc -o ./tmp.txt
cpp  -Iinclude -Ilibcxx -Idrivers -Icommon -Ikernel -D_GLIBCXX_HOSTED=1 kernel/hal/arch/x64/gdt/gdt.asm -o ./tmp.txt
cpp  -Iinclude -Ilibcxx -Idrivers -Icommon -Ikernel -D_GLIBCXX_HOSTED=1 kernel/hal/arch/x64/idt/isr.asm -o ./tmp.txt
cpp  -Iinclude -Ilibcxx -Idrivers -Icommon -Ikernel -D_GLIBCXX_HOSTED=1 kernel/hal/arch/x64/idt/idt.asm -o ./tmp.txt
cpp  -Iinclude -Ilibcxx -Idrivers -Icommon -Ikernel -D_GLIBCXX_HOSTED=1 kernel/hal/arch/x64/idt/isr.cc -o ./tmp.txt
cpp  -Iinclude -Ilibcxx -Idrivers -Icommon -Ikernel -D_GLIBCXX_HOSTED=1 kernel/hal/arch/x64/idt/idt.cc -o ./tmp.txt
ld -nostdlib -g -O2 bin/kernel/driver/driver.cc.o bin/kernel/mmu/pmm/pmm.cc.o bin/kernel/mmu/rtl.cc.o bin/kernel/mmu/vmm/vmm.cc.o bin/kernel/mmu/heap/heap.cc.o bin/kernel/vfs/vfs.cc.o bin/kernel/main.cc.o bin/kernel/hal/arch/init.cc.o bin/kernel/hal/arch/x64/gdt/gdt.asm.o bin/kernel/hal/arch/x64/gdt/gdt.cc.o bin/kernel/hal/arch/x64/idt/idt.cc.o bin/kernel/hal/arch/x64/idt/isr.asm.o bin/kernel/hal/arch/x64/idt/idt.asm.o bin/kernel/hal/arch/x64/idt/isr.cc.o -T util/linker.ld --no-whole-archive --whole-archive bin/libcxx.a bin/drivers.a bin/common.a -o bin/kernel.elf
strip --keep-section-symbols --strip-debug bin/kernel.elf -o bin/kernel.elf
objdump -C -d -Mintel bin/kernel.elf > bin/kernel.asm
rm -f bin/image.img
dd if=/dev/zero of=bin/image.img bs=1M count=128
parted bin/image.img --script mklabel gpt
parted bin/image.img --script mkpart EFI FAT32 2048s 100MB
parted bin/image.img --script mkpart ROOT ext4 100MB 100%
parted bin/image.img --script set 1 boot on
sudo losetup --show -f -P bin/image.img > /tmp/tmp.txt
sudo mkfs.fat -F32 /dev/loop0p1
sudo mkfs.ext4 /dev/loop0p2
mkdir -p mnt
sudo mount /dev/loop0p1 mnt
sudo mkdir -p mnt/EFI/BOOT
sudo cp bin/BOOTX64.EFI mnt/EFI/BOOT
sudo cp bin/kernel.elf mnt
sudo cp bin/limine.conf mnt
sudo umount mnt
sudo losetup -d /dev/loop0
rm -rf mnt
./script/run.sh bin
